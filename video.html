<!DOCTYPE html>
<html>
<head>
  <title>Multi-User Video Call</title>
  <style>
    #videos {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    video {
      width: 300px;
      height: 225px;
      background-color: black;
    }
  </style>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
  <h1>Multi-User Video Call</h1>
  <input type="text" id="roomId" placeholder="Enter Room ID" />
  <button id="joinBtn">Join Room</button>
  <div id="videos"></div>

  <script>
    const socket = io("http://localhost:9000");
    const peers = {};
    const videosDiv = document.getElementById("videos");
    let localStream = null;
    let roomId = "";

    async function initLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const localVideo = document.createElement("video");
        localVideo.srcObject = localStream;
        localVideo.autoplay = true;
        localVideo.muted = true; // mute local video
        videosDiv.appendChild(localVideo);
      } catch (err) {
        console.error("Error accessing media:", err);
      }
    }

    document.getElementById("joinBtn").onclick = async () => {
      roomId = document.getElementById("roomId").value;
      if (!roomId) return alert("Enter a Room ID");

      await initLocalStream();
      socket.emit("join-room", roomId);
    };

    // When a new user joins, create a peer connection
    socket.on("user-connected", async (userId) => {
      console.log("User connected:", userId);
      const pc = createPeerConnection(userId);
      peers[userId] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    });

    socket.on("offer", async (data) => {
      const pc = createPeerConnection(data.from);
      peers[data.from] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", { sdp: answer, to: data.from });
    });

    socket.on("answer", async (data) => {
      await peers[data.from].setRemoteDescription(new RTCSessionDescription(data.sdp));
    });

    socket.on("ice-candidate", async (data) => {
      try {
        await peers[data.from].addIceCandidate(new RTCIceCandidate(data.candidate));
      } catch (err) {
        console.error(err);
      }
    });

    socket.on("user-disconnected", (userId) => {
      console.log("User disconnected:", userId);
      if (peers[userId]) {
        peers[userId].close();
        delete peers[userId];
      }
      const vid = document.getElementById(userId);
      if (vid) vid.remove();
    });

    function createPeerConnection(userId) {
      const pc = new RTCPeerConnection();

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", { candidate: event.candidate, to: userId });
        }
      };

      pc.ontrack = (event) => {
        let video = document.getElementById(userId);
        if (!video) {
          video = document.createElement("video");
          video.id = userId;
          video.autoplay = true;
          videosDiv.appendChild(video);
        }
        video.srcObject = event.streams[0];
      };

      return pc;
    }
  </script>
</body>
</html>
